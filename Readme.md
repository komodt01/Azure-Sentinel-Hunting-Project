# Azure Sentinel + Python Threat Hunting PoC

This project demonstrates a practical threat hunting proof of concept using **Microsoft Sentinel**, **Log Analytics**, and a **Python** script that runs Kusto (KQL) queries against Azure sign-in data.

The goal is to show how a security architect can move beyond “logs exist” to **actively querying and analyzing identity-related events** (e.g., suspicious sign-in patterns) using Azure-native services and automation.

---

## Architecture Overview

High-level flow:

1. **Identity activity** is generated by users and applications authenticating against Microsoft Entra ID.
2. **Entra ID sign-in data** (such as `SigninLogs`) is sent to a **Log Analytics workspace**, with Microsoft Sentinel enabled on top for SIEM capabilities.
3. A **Python script (`sentinel_query.py`)** uses `DefaultAzureCredential` and `LogsQueryClient` from the Azure Monitor SDK to run KQL queries against the workspace.
4. The script retrieves recent sign-in events (or other tables) and prints or exports results for investigation.
5. A **security analyst** reviews the output to identify anomalies, investigate trends, or iteratively refine hunting queries.

This PoC focuses on **identity-centric threat hunting**, not on fully building out all Sentinel analytics rules or SOAR playbooks.

---

## Key Components

- **Microsoft Entra ID** – Source of `SigninLogs` and audit events.
- **Log Analytics Workspace** – Centralized log store queried by Sentinel and Python.
- **Microsoft Sentinel** – SIEM layer providing security context and advanced capabilities.
- **Python Threat Hunting Script (`sentinel_query.py`)** – Uses Azure Monitor `LogsQueryClient` and KQL.
- **Kusto Query Language (KQL)** – Used to define hunts (e.g., suspicious or failed sign-ins, risky IPs).

---

## Files in This Project

- `business-case.md` – Why this hunting PoC exists and what problem it addresses.
- `design_overview.md` – Architecture, trade-offs, and Well-Architected mapping.
- `security_requirements.md` – Objectives, derived requirements, and implemented controls.
- `risks_and_mitigations.md` – Key risks, limitations, and recommended next steps.
- `manual.md` – Step-by-step runbook for configuring and running the hunt.
- `sentinel_query.py` – Python script that runs KQL against Log Analytics.

---

## How to Use This PoC

1. **Configure Log Analytics / Sentinel**
   - Ensure a Log Analytics workspace exists.
   - Connect `SigninLogs` (and optionally other tables like `AuditLogs`) to the workspace.
   - Enable Microsoft Sentinel on that workspace if desired.

2. **Set Up Authentication**
   - Use `az login` (Azure CLI) or a managed identity so `DefaultAzureCredential` can authenticate.
   - Confirm the identity has permission to query the Log Analytics workspace.

3. **Update the Script**
   - In `sentinel_query.py`, set `workspace_id` to your workspace ID.
   - Adjust the `query` string from `SigninLogs | take 5` to your own KQL hunting logic.

4. **Run the Hunt**
   - Execute the script from your terminal:
     ```bash
     python sentinel_query.py
     ```
   - Review results and iterate on KQL as you refine what “suspicious” looks like.

5. **Extend the PoC**
   - Add more complex KQL queries (e.g., impossible travel, unfamiliar sign-in properties).
   - Export results to CSV or integrate with ticketing/notification systems.
   - Use this PoC as a design pattern for broader Sentinel-based threat hunting.

---

## What This Project Demonstrates

- How to **integrate Python automation with Microsoft Sentinel/Log Analytics**.
- How to **treat logs as a hunting dataset**, not just a compliance checkbox.
- How to **express security hypotheses in KQL** and validate them with real data.
- How a Cloud Security Architect can design, document, and automate a focused hunting workflow.
